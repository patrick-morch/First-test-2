<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Min livstracker</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --card:#15171d; --muted:#6c7480; --text:#e8eef5; --border:#272a33; --accent:#4f8cff;
      --ring-bg:#0f1116;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text)}
    header{max-width:1100px; margin:24px auto 0; padding:0 16px}
    main{max-width:1100px; margin:12px auto 40px; padding:0 16px}
    h1{margin:0 0 8px; font-size:28px}
    .muted{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr 1.8fr; gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-weight:600; margin-bottom:6px}
    input,select,button,textarea{padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid var(--border); background:#0f1116; color:var(--text)}
    textarea{width:100%}
    button{cursor:pointer; background:#111520; transition:all .15s ease; border-color:#1e2230}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent); border-color:transparent; color:#fff}
    .btn-danger{background:#6a1216; border-color:#6a1216; color:#fff}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#10131b}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:700px){.split{grid-template-columns:1fr}}
    .field-card{border:1px dashed var(--border); border-radius:12px; padding:12px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:8px}
    @media (max-width:700px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .item{background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px}

    /* Fremdriftsring */
    .ring{width:120px; height:120px; border-radius:50%; display:grid; place-items:center; background:
      conic-gradient(var(--accent) calc(var(--p)*1%), #2a2f3a 0);
      position:relative}
    .ring::after{content:""; position:absolute; inset:8px; background:var(--ring-bg); border-radius:50%; border:1px solid var(--border)}
    .ring > span{position:relative; z-index:1; font-weight:800}

    /* Minikalender */
    .calendar{position:relative; display:inline-block}
    .cal-pop{position:absolute; z-index:50; top:42px; left:0; background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px; width:280px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{padding:8px 0; text-align:center; border:1px solid var(--border); border-radius:8px; cursor:pointer; user-select:none}
    .cal-cell.muted{opacity:.5}
    .cal-cell.sel{outline:2px solid var(--accent)}
    .cal-cell.good{background:rgba(0,255,0,.08); border-color:rgba(0,255,0,.25)}
    .cal-cell.bad{background:rgba(255,0,0,.06); border-color:rgba(255,0,0,.2)}
    .cal-dow{font-size:11px; text-align:center; color:var(--muted)}

    .status{position:fixed; right:16px; bottom:16px; background:#10131b; border:1px solid var(--border); padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(8px); transition:all .2s ease}
    .status.show{opacity:1; transform:none}
    .badge{padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#10131b; font-size:12px}
    .list{display:grid; gap:8px}
    .list .rowline{display:flex; justify-content:space-between; align-items:center; gap:10px; background:#0f1116; border:1px solid var(--border); border-radius:10px; padding:8px 10px}
    .bar{height:8px; background:#2a2f3a; border-radius:999px; overflow:hidden}
    .bar > i{display:block; height:100%; background:var(--accent)}
  </style>
</head>
<body>
  <header>
    <h1>Min livstracker</h1>
    <div class="muted">Alt lagres lokalt. Tema og farger kan tilpasses. Dato velges fra kalender.</div>
  </header>

  <main class="grid">
    <!-- Venstre: felter, dato, skjema -->
    <section class="card">
      <h2 style="margin:0 0 8px">Felter</h2>
      <div class="split">
        <div>
          <label>Navn</label>
          <input id="fName" placeholder="f.eks. Søvn (timer)" />
        </div>
        <div>
          <label>Type</label>
          <select id="fType">
            <option value="number">Tall</option>
            <option value="checkbox">Checkbox</option>
            <option value="text">Tekst</option>
            <option value="textarea">Lang tekst</option>
          </select>
        </div>
      </div>
      <div class="split" style="margin-top:8px">
        <div>
          <label>Mål (kun for tall)</label>
          <input id="fGoal" type="number" inputmode="decimal" step="any" placeholder="f.eks. 8" />
        </div>
        <div class="row" style="align-items:center; margin-top:28px">
          <input id="fInProg" type="checkbox" checked />
          <label for="fInProg" style="margin:0">Ta med i fremdrift</label>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addField" class="btn-primary">Legg til felt</button>
        <button id="addPreset" class="pill">Forhåndsoppsett</button>
        <button id="resetAll" class="btn-danger">Slett alt</button>
      </div>

      <div id="fieldList" style="margin-top:14px; display:grid; gap:10px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Før data</h2>
      <div class="row" style="align-items:center">
        <div class="calendar">
          <label for="datePicker">Dato</label>
          <div class="row" style="align-items:center">
            <input id="datePicker" type="date" />
            <button id="openCal" title="Åpne kalender" class="pill">Kalender</button>
          </div>
          <div id="calPop" class="cal-pop" style="display:none"></div>
        </div>
        <button id="prevDay" class="pill">← Forrige</button>
        <button id="todayBtn" class="pill">I dag</button>
        <button id="nextDay" class="pill">Neste →</button>
        <span id="datePretty" class="badge"></span>
      </div>

      <div id="formArea" style="margin-top:12px; display:grid; grid-template-columns:1fr; gap:12px"></div>
      <div class="row" style="margin-top:12px">
        <button id="save" class="btn-primary">Lagre</button>
        <button id="export" class="pill">Eksporter JSON</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>
    </section>

    <!-- Høyre: oversikt, mål, graf, historikk, tema -->
    <section class="card">
      <h2 style="margin:0 0 8px">Dagens oversikt</h2>
      <div class="row" style="align-items:center">
        <div id="ring" class="ring" style="--p:0"><span id="ringPct">0%</span></div>
        <div>
          <div class="muted">Total fremdrift</div>
          <div id="ringText" style="font-size:18px; font-weight:700">0 av 0 mål</div>
        </div>
      </div>
      <div id="progressList" class="list" style="margin-top:10px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Mål (uke/måned)</h2>
      <div class="split">
        <div>
          <label>Felt</label>
          <select id="goalField"></select>
        </div>
        <div>
          <label>Periode</label>
          <select id="goalPeriod">
            <option value="week">Uke</option>
            <option value="month">Måned</option>
          </select>
        </div>
      </div>
      <div class="split" style="margin-top:10px">
        <div>
          <label>Aggregasjon</label>
          <select id="goalAgg">
            <option value="sum">Sum</option>
            <option value="avg">Snitt</option>
          </select>
        </div>
        <div>
          <label>Target</label>
          <input id="goalTarget" type="number" step="any" placeholder="f.eks. 4" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addGoal" class="btn-primary">Legg til mål</button>
      </div>
      <div id="goalList" class="list" style="margin-top:12px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Graf</h2>
      <div class="split">
        <div>
          <label>Felt</label>
          <select id="chartField"></select>
        </div>
        <div>
          <label>Periode</label>
          <select id="chartRange">
            <option value="week">Uke</option>
            <option value="month" selected>Måned</option>
            <option value="year">År</option>
            <option value="all">Alt</option>
          </select>
        </div>
      </div>
      <div class="split" style="margin-top:10px">
        <div>
          <label>Aggregasjon</label>
          <select id="chartAgg">
            <option value="avg" selected>Snitt</option>
            <option value="sum">Sum</option>
          </select>
        </div>
        <div>
          <label>Gruppering</label>
          <select id="chartGroup">
            <option value="auto" selected>Auto</option>
            <option value="day">Dag</option>
            <option value="week">Uke</option>
            <option value="month">Måned</option>
          </select>
        </div>
      </div>
      <div style="margin-top:14px"><canvas id="chart" height="160"></canvas></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Historikk (siste 14 dager)</h2>
      <div id="history"></div>

      <div class="kpi">
        <div class="item"><div class="muted">Dager ført</div><div id="kpiDays" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Felt</div><div id="kpiFields" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Nyeste dato</div><div id="kpiLatest" style="font-size:18px; font-weight:700">–</div></div>
        <div class="item">
          <div class="muted">Tema</div>
          <div class="row" style="margin-top:6px">
            <select id="themeSel">
              <option value="dark" selected>Mørk</option>
              <option value="light">Lys</option>
              <option value="emerald">Emerald</option>
              <option value="solar">Solar</option>
            </select>
            <input id="bgColor" type="color" title="Bakgrunn" />
            <input id="accentColor" type="color" title="Aksent" />
            <button id="themeReset" class="pill">Nullstill</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="status" class="status"></div>

<script>
  const LS_KEY = "life_tracker_v3";
  const el = (id) => document.getElementById(id);
  const todayISO = () => new Date().toLocaleDateString("sv-SE");
  const MONTHS = ["jan","feb","mar","apr","mai","jun","jul","aug","sep","okt","nov","des"];

  function prettyDate(iso){
    if(!iso) return "—";
    const [y,m,d] = iso.split("-").map(Number);
    const name = MONTHS[(m||1)-1] || "";
    return `${d}. ${name}, ${y}`;
  }

  function defaultSettings(){ return { theme:"dark", bg:"#0b0c10", accent:"#4f8cff", goals: [] }; }
  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(raw){
        const s = JSON.parse(raw);
        s.fields ||= [];
        s.entries ||= {};
        s.settings ||= defaultSettings();
        s.settings.goals ||= [];
        return s;
      }
    }catch{}
    const s = { fields: [], entries: {}, settings: defaultSettings() };
    saveState(s); return s;
  }
  function saveState(state){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

  // Theme
  function applyTheme(settings){
    const root = document.documentElement;
    const theme = settings.theme || "dark";
    const accent = settings.accent || "#4f8cff";
    let bg = settings.bg || (theme==="light" ? "#f7f7f9" : "#0b0c10");
    if(theme==="dark"){
      root.style.setProperty("--bg", bg);
      root.style.setProperty("--card", "#15171d");
      root.style.setProperty("--text", "#e8eef5");
      root.style.setProperty("--muted", "#6c7480");
      root.style.setProperty("--border", "#272a33");
      root.style.setProperty("--ring-bg", "#0f1116");
    }else if(theme==="light"){
      root.style.setProperty("--bg", bg);
      root.style.setProperty("--card", "#ffffff");
      root.style.setProperty("--text", "#101317");
      root.style.setProperty("--muted", "#5f6b7a");
      root.style.setProperty("--border", "#e5e7eb");
      root.style.setProperty("--ring-bg", "#ffffff");
    }else if(theme==="emerald"){
      bg = settings.bg || "#06110f";
      root.style.setProperty("--bg", bg);
      root.style.setProperty("--card", "#0d1917");
      root.style.setProperty("--text", "#e6fff9");
      root.style.setProperty("--muted", "#89a39b");
      root.style.setProperty("--border", "#1f2b28");
      root.style.setProperty("--ring-bg", "#0d1917");
    }else if(theme==="solar"){
      bg = settings.bg || "#0d0f10";
      root.style.setProperty("--bg", bg);
      root.style.setProperty("--card", "#14181b");
      root.style.setProperty("--text", "#f2efe6");
      root.style.setProperty("--muted", "#c2c0b5");
      root.style.setProperty("--border", "#2b2f31");
      root.style.setProperty("--ring-bg", "#14181b");
    }
    root.style.setProperty("--accent", accent);
  }

  // Utils
  const escapeHtml = (s) => String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const escapeAttr = (s) => escapeHtml(s).replaceAll("\n","&#10;");
  const uid = () => "id_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  const toNumber = (v) => { if (typeof v === "number") return v; if (typeof v === "boolean") return v ? 1 : 0; const n = Number(v); return Number.isFinite(n) ? n : 0; };
  const showToast = (msg) => { const node = el("status"); node.textContent = msg; node.classList.add("show"); setTimeout(()=> node.classList.remove("show"), 1200); };

  // Fields
  function renderFields(){
    const state = loadState();
    const wrap = el("fieldList");
    wrap.innerHTML = "";
    if(!state.fields.length){ wrap.innerHTML = `<div class="muted">Ingen felter enda.</div>`; return; }
    state.fields.forEach((f, idx) => {
      const card = document.createElement("div");
      card.className = "field-card";
      const top = document.createElement("div"); top.className = "row"; top.style.justifyContent="space-between";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(f.name)}</div>
        <div class="muted" style="font-size:12px">${f.type}${f.type==="number" && f.goal ? ` • mål: ${f.goal}`:""}${f.inProgress ? " • i fremdrift":""}</div>`;
      const del = document.createElement("button"); del.className="btn-danger"; del.textContent="Fjern";
      del.onclick = () => {
        const s = loadState();
        const removed = s.fields.splice(idx,1)[0];
        if(removed){
          Object.keys(s.entries).forEach(d => { if(s.entries[d]) delete s.entries[d][removed.id]; });
          s.settings.goals = (s.settings.goals||[]).filter(g => g.fieldId !== removed.id);
        }
        saveState(s); renderAll();
      };
      top.appendChild(left); top.appendChild(del);

      const edit = document.createElement("div"); edit.className="row";
      edit.innerHTML = `
        <input class="pill" data-edit="name" style="min-width:220px" value="${escapeAttr(f.name)}" />
        ${f.type==="number" ? `<input class="pill" data-edit="goal" type="number" step="any" placeholder="Mål" value="${f.goal ?? ""}" />` : ""}
        <label class="row" style="align-items:center; gap:6px">
          <input data-edit="inProgress" type="checkbox" ${f.inProgress ? "checked": ""} /> I fremdrift
        </label>
        <button class="pill" data-edit="save">Oppdater</button>
      `;
      edit.querySelector('[data-edit="save"]').onclick = () => {
        const s = loadState();
        const item = s.fields[idx]; if(!item) return;
        const name = edit.querySelector('[data-edit="name"]').value.trim(); if(name) item.name = name;
        if(item.type==="number"){ const g = edit.querySelector('[data-edit="goal"]').value.trim(); item.goal = g ? Number(g) : null; }
        item.inProgress = edit.querySelector('[data-edit="inProgress"]').checked;
        saveState(s); renderAll(); showToast("Felt oppdatert");
      };

      card.appendChild(top); card.appendChild(edit); wrap.appendChild(card);
    });
  }

  // Form per dag
  function renderForm(dateISO){
    const state = loadState();
    const form = el("formArea");
    form.innerHTML = "";
    if(!state.fields.length){ form.innerHTML = `<div class="muted">Legg til felter over for å kunne føre.</div>`; return; }
    const dayData = state.entries[dateISO] || {};
    state.fields.forEach(f => {
      const block = document.createElement("div"); block.className = "card"; block.style.padding = "12px"; block.style.background = "#0f1116";
      const label = document.createElement("div"); label.style.fontWeight="700"; label.style.marginBottom="8px"; label.textContent = f.name;
      let inputHtml = ""; const val = dayData[f.id];
      if(f.type === "text"){
        inputHtml = `<input data-id="${f.id}" type="text" value="${escapeAttr(val ?? "")}" />`;
      } else if(f.type === "number"){
        inputHtml = `<input data-id="${f.id}" type="number" inputmode="decimal" step="any" value="${escapeAttr(val ?? "")}" />`;
      } else if(f.type === "checkbox"){
        const checked = !!val; inputHtml = `<label class="row" style="align-items:center; gap:8px"><input data-id="${f.id}" type="checkbox" ${checked ? "checked":""} /> <span class="muted">Huket av</span></label>`;
      } else {
        inputHtml = `<textarea data-id="${f.id}" rows="4">${escapeHtml(val ?? "")}</textarea>`;
      }
      block.appendChild(label); const field = document.createElement("div"); field.innerHTML = inputHtml; block.appendChild(field); form.appendChild(block);
    });
  }

  // Daglig fremdrift
  function computeProgressForField(field, value){
    if(!field.inProgress) return null;
    if(field.type === "checkbox"){ return value ? 1 : 0; }
    if(field.type === "number"){ const goal = Number(field.goal || 0); const v = toNumber(value); if(goal > 0){ return Math.min(v/goal, 1); } return null; }
    return null;
  }
  function computeDayTotalPercent(iso){
    const state = loadState();
    const day = state.entries[iso] || {};
    const parts = [];
    state.fields.forEach(f => {
      const p = computeProgressForField(f, day[f.id]);
      if(p !== null) parts.push(p);
    });
    if(!parts.length) return 0;
    return Math.round( (parts.reduce((a,b)=>a+b,0) / parts.length) * 100 );
  }
  function renderProgress(dateISO){
    const state = loadState();
    const day = state.entries[dateISO] || {};
    const list = el("progressList"); list.innerHTML = "";
    const rows = [];
    state.fields.forEach(f => {
      const val = day[f.id];
      const p = computeProgressForField(f, val);
      if(p === null) return;
      rows.push({ name:f.name, pct:Math.round(p*100), raw:val, goal:f.goal, type:f.type });
    });
    const totalCount = rows.length;
    const sumPct = rows.reduce((a,b)=>a+b.pct,0);
    const avgPct = totalCount ? Math.round(sumPct / totalCount) : 0;
    el("ring").style.setProperty("--p", avgPct);
    el("ringPct").textContent = `${avgPct}%`;
    el("ringText").textContent = `${rows.filter(r=>r.pct===100).length} av ${totalCount} mål`;
    if(!rows.length){
      list.innerHTML = `<div class="muted">Ingen felt inngår i fremdrift i dag. Marker “I fremdrift” på feltene (og legg mål for tall).</div>`;
    }else{
      rows.forEach(r => {
        const row = document.createElement("div"); row.className = "rowline";
        const left = document.createElement("div");
        const goalTxt = (r.type==="number" && r.goal) ? ` • mål: ${r.goal}` : "";
        left.innerHTML = `<div style="font-weight:700">${escapeHtml(r.name)}</div><div class="muted" style="font-size:12px">verdi: ${r.raw ?? "—"}${goalTxt}</div>`;
        const right = document.createElement("div"); right.style.minWidth="160px";
        right.innerHTML = `<div style="text-align:right; font-weight:700">${r.pct}%</div><div class="bar"><i style="width:${r.pct}%"></i></div>`;
        row.appendChild(left); row.appendChild(right); list.appendChild(row);
      });
    }
  }

  // Historikk
  function renderHistory(){
    const state = loadState();
    const historyEl = el("history");
    const dates = Object.keys(state.entries).sort();
    const last = dates.slice(-14);
    if(!last.length){ historyEl.innerHTML = `<div class="muted">Ingen historikk enda.</div>`; return; }
    const visibleFields = state.fields.filter(f => f.type !== "textarea");
    let html = `<div style="overflow:auto"><table><thead><tr><th>Dato</th>${
      visibleFields.map(f => `<th>${escapeHtml(f.name)}</th>`).join("")
    }</tr></thead><tbody>`;
    last.forEach(d => {
      const row = state.entries[d] || {};
      html += `<tr><td>${prettyDate(d)}</td>${
        visibleFields.map(f => {
          const v = row[f.id];
          if (f.type === "checkbox") return `<td>${v ? "✅" : "—"}</td>`;
          return `<td>${v ?? "—"}</td>`;
        }).join("")
      }</tr>`;
    });
    html += `</tbody></table></div>`;
    historyEl.innerHTML = html;
  }

  // KPI
  function renderKpi(){
    const state = loadState();
    const days = Object.keys(state.entries).length;
    const latest = Object.keys(state.entries).sort().slice(-1)[0] || "—";
    el("kpiDays").textContent = String(days);
    el("kpiFields").textContent = String(state.fields.length);
    el("kpiLatest").textContent = latest==="—" ? "—" : prettyDate(latest);
  }

  // Chart
  let chart;
  function renderChartControls(){
    const state = loadState();
    const chartField = el("chartField");
    const eligible = state.fields.filter(f => f.type === "number" || f.type === "checkbox");
    chartField.innerHTML = eligible.length
      ? eligible.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join("")
      : `<option disabled>Ingen tall/checkbox-felt</option>`;
  }
  function groupKey(date, mode){
    const d = new Date(date + "T00:00:00");
    if(mode === "day"){ return prettyDate(date); }
    if(mode === "week"){
      const tmp = new Date(d); const day = (tmp.getDay() + 6) % 7; tmp.setDate(tmp.getDate() - day);
      const year = tmp.getFullYear(); const jan4 = new Date(year,0,4); const jan4Day = (jan4.getDay()+6)%7;
      const weekStart = new Date(tmp);
      const diff = Math.round((weekStart - (new Date(year,0,4 - jan4Day)))/86400000);
      const week = Math.floor(diff/7)+1;
      return `Uke ${String(week).padStart(2,"0")} ${year}`;
    }
    if(mode === "month"){ const [y,m] = date.split("-").map(Number); return `${MONTHS[(m||1)-1]} ${y}`; }
    return prettyDate(date);
  }
  function inferGroup(range){ if(range === "week") return "day"; if(range === "month") return "day"; if(range === "year") return "month"; return "month"; }
  function computeDateRange(range){
    const end = new Date(); end.setHours(0,0,0,0);
    const start = new Date(end);
    if(range === "week") start.setDate(end.getDate()-6);
    else if(range === "month") start.setMonth(end.getMonth()-1);
    else if(range === "year") start.setFullYear(end.getFullYear()-1);
    else start.setFullYear(end.getFullYear()-5);
    return [start.toLocaleDateString("sv-SE"), end.toLocaleDateString("sv-SE")];
  }
  function renderChart(){
    const state = loadState();
    const cf = el("chartField").value;
    if(!cf){ drawEmpty(); return; }
    const range = el("chartRange").value;
    const agg = el("chartAgg").value;
    const groupSel = el("chartGroup").value;
    const [from, to] = computeDateRange(range);

    const entries = Object.entries(state.entries).filter(([d]) => d >= from && d <= to).sort(([a],[b]) => a.localeCompare(b));
    const f = state.fields.find(x => x.id === cf);
    const numeric = entries.map(([d, obj]) => {
      const raw = obj?.[cf];
      const val = f?.type === "checkbox" ? (raw ? 1 : 0) : toNumber(raw);
      const has = (f?.type === "checkbox") ? (raw === true) : (raw !== undefined && raw !== null && raw !== "");
      return [d, val, has];
    });

    const grpMode = groupSel === "auto" ? inferGroup(range) : groupSel;
    const groups = new Map();
    for(const [d,v,has] of numeric){
      const key = groupKey(d, grpMode);
      if(!groups.has(key)) groups.set(key, {sum:0, count:0});
      const g = groups.get(key);
      if(has){ g.sum += v; g.count += 1; }
    }
    const labels = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b));
    const data = labels.map(k => { const g = groups.get(k); return (agg === "sum") ? g.sum : (g.count ? g.sum / g.count : 0); });

    const ctx = el("chart").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label: f?.name || "Verdi", data, tension:.3, fill:false, borderColor:getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() }]},
      options: {
        responsive:true,
        scales:{ x:{ grid:{ color:"rgba(127,127,127,.15)"} }, y:{ grid:{ color:"rgba(127,127,127,.15)"}, beginAtZero:true, ticks:{ color:getTextColor() } } },
        plugins:{ legend:{ labels:{ color:getTextColor() } }, tooltip:{ mode:"index", intersect:false } }
      }
    });
  }
  function drawEmpty(){ const ctx = el("chart").getContext("2d"); if(chart) chart.destroy(); chart = new Chart(ctx, { type:"line", data:{labels:[], datasets:[{label:"", data:[]}]}, options:{} }); }
  function getTextColor(){ return getComputedStyle(document.documentElement).getPropertyValue("--text").trim() || "#fff"; }

  // Kalender + uke/mnd helpers
  function addDays(iso, delta){ const d = new Date(iso+"T00:00:00"); d.setDate(d.getDate()+delta); return d.toLocaleDateString("sv-SE"); }
  function startOfISOWeek(iso){ const d=new Date(iso+"T00:00:00"); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); return d.toLocaleDateString("sv-SE"); }
  function endOfISOWeek(iso){ const s=new Date(startOfISOWeek(iso)+"T00:00:00"); s.setDate(s.getDate()+6); return s.toLocaleDateString("sv-SE"); }
  function monthBounds(iso){ const d=new Date(iso+"T00:00:00"); const s=new Date(d.getFullYear(), d.getMonth(), 1); const e=new Date(d.getFullYear(), d.getMonth()+1, 0); return [s.toLocaleDateString("sv-SE"), e.toLocaleDateString("sv-SE")]; }

  function monthData(baseIso){
    const base = new Date(baseIso+"T00:00:00");
    const year = base.getFullYear(), month = base.getMonth();
    const first = new Date(year, month, 1);
    const startOffset = (first.getDay()+6)%7; // 0=Mon
    const start = new Date(year, month, 1 - startOffset);
    const cells = [];
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const iso = d.toLocaleDateString("sv-SE");
      cells.push({ iso, inMonth: d.getMonth()===month, day:d.getDate() });
    }
    return { year, month, title: `${MONTHS[month]} ${year}`, cells };
  }

  function renderCalendar(currentIso){
    const pop = el("calPop"); pop.innerHTML = "";
    let baseIso = currentIso || todayISO();
    const head = document.createElement("div"); head.className="cal-head";
    const title = document.createElement("div"); title.style.fontWeight="700";
    const prev = document.createElement("button"); prev.className="pill"; prev.textContent="←";
    const next = document.createElement("button"); next.className="pill"; next.textContent="→";
    const today = document.createElement("button"); today.className="pill"; today.textContent="I dag";
    head.appendChild(prev); head.appendChild(title); head.appendChild(next); head.appendChild(today);

    const dows = document.createElement("div"); dows.className="cal-grid";
    ["Ma","Ti","On","To","Fr","Lø","Sø"].forEach(x=>{ const c=document.createElement("div"); c.className="cal-dow"; c.textContent=x; dows.appendChild(c); });
    const grid = document.createElement("div"); grid.className="cal-grid";

    function paint(){
      const md = monthData(baseIso);
      title.textContent = md.title;
      grid.innerHTML = "";
      md.cells.forEach(c => {
        const cell = document.createElement("div");
        const pct = computeDayTotalPercent(c.iso);
        let cls = "cal-cell";
        if(c.iso===el("datePicker").value) cls += " sel";
        if(pct>=100) cls += " good";
        else if(pct>0) cls += " bad";
        if(!c.inMonth) cls += " muted";
        cell.className = cls;
        cell.textContent = c.day;
        cell.title = pct ? `${pct}%` : "—";
        cell.onclick = () => { el("datePicker").value = c.iso; updateDateUI(); closeCal(); };
        grid.appendChild(cell);
      });
    }
    prev.onclick = () => { const d=new Date(baseIso+"T00:00:00"); d.setMonth(d.getMonth()-1); baseIso = d.toLocaleDateString("sv-SE"); paint(); };
    next.onclick = () => { const d=new Date(baseIso+"T00:00:00"); d.setMonth(d.getMonth()+1); baseIso = d.toLocaleDateString("sv-SE"); paint(); };
    today.onclick = () => { baseIso = todayISO(); el("datePicker").value = baseIso; updateDateUI(); closeCal(); };
    pop.appendChild(head); pop.appendChild(dows); pop.appendChild(grid); paint();
  }
  function openCal(){ const pop = el("calPop"); pop.style.display="block"; renderCalendar(el("datePicker").value || todayISO()); }
  function closeCal(){ const pop = el("calPop"); pop.style.display="none"; }

  // Goals (uke/måned)
  function renderGoalControls(){
    const state = loadState();
    const goalField = el("goalField");
    const eligible = state.fields.filter(f => f.type==="checkbox" || f.type==="number");
    goalField.innerHTML = eligible.length ? eligible.map(f => `<option value="${f.id}" data-type="${f.type}">${escapeHtml(f.name)}</option>`).join("") : `<option disabled>Ingen passende felt</option>`;
    // Disable/enable agg for checkbox
    const updateAgg = () => {
      const sel = goalField.options[goalField.selectedIndex]; if(!sel) return;
      const t = sel.getAttribute("data-type");
      el("goalAgg").value = t==="checkbox" ? "sum" : el("goalAgg").value;
      el("goalAgg").disabled = (t==="checkbox");
    };
    goalField.onchange = updateAgg; updateAgg();
  }
  function getRangeForPeriod(baseIso, period){
    if(period==="week") return [startOfISOWeek(baseIso), endOfISOWeek(baseIso)];
    return monthBounds(baseIso);
  }
  function aggregateFieldOverRange(field, fromIso, toIso, agg){
    const state = loadState();
    const dates = Object.keys(state.entries).filter(d => d>=fromIso && d<=toIso);
    let sum=0, count=0;
    dates.forEach(d=>{
      const raw = state.entries[d]?.[field.id];
      if(field.type==="checkbox"){
        if(raw === true){ sum += 1; count += 1; }
      }else if(field.type==="number"){
        if(raw !== undefined && raw !== null && raw!==""){ sum += toNumber(raw); count += 1; }
      }
    });
    if(agg==="sum") return sum;
    return count ? (sum/count) : 0;
  }
  function renderGoals(baseIso){
    const state = loadState();
    const list = el("goalList");
    list.innerHTML = "";
    const goals = state.settings.goals || [];
    if(!goals.length){
      list.innerHTML = `<div class="muted">Ingen mål enda. Legg til et mål over (eks: Trening • Uke • Sum • 4).</div>`;
      return;
    }
    goals.forEach((g, idx) => {
      const f = state.fields.find(x=>x.id===g.fieldId); if(!f) return;
      const [from,to] = getRangeForPeriod(baseIso, g.period);
      const value = aggregateFieldOverRange(f, from, to, g.agg);
      const pct = g.target>0 ? Math.min(100, Math.round((value/g.target)*100)) : 0;
      const row = document.createElement("div"); row.className="rowline";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(f.name)} • ${g.period==="week"?"Uke":"Måned"} • ${g.agg==="sum"?"Sum":"Snitt"}</div>
        <div class="muted" style="font-size:12px">${prettyDate(from)} – ${prettyDate(to)} • verdi: ${Number.isFinite(value)?value.toFixed(2):value} • mål: ${g.target}</div>`;
      const right = document.createElement("div"); right.style.minWidth="200px";
      right.innerHTML = `<div style="text-align:right; font-weight:700">${pct}%</div><div class="bar"><i style="width:${pct}%"></i></div>`;
      const del = document.createElement("button"); del.className="pill"; del.textContent="Slett";
      del.onclick = ()=>{ const s=loadState(); s.settings.goals.splice(idx,1); saveState(s); renderGoals(baseIso); showToast("Mål slettet"); };
      row.appendChild(left); row.appendChild(right); row.appendChild(del); list.appendChild(row);
    });
  }

  // Handlers
  el("addField").onclick = () => {
    const name = el("fName").value.trim();
    const type = el("fType").value;
    const goalRaw = el("fGoal").value.trim();
    const inProg = el("fInProg").checked;
    if(!name) return;
    const state = loadState();
    state.fields.push({ id: uid(), name, type, inProgress: !!inProg, goal: (type==="number" && goalRaw) ? Number(goalRaw) : null });
    saveState(state);
    el("fName").value = ""; el("fGoal").value = ""; el("fInProg").checked = true;
    renderAll();
    showToast("Felt lagt til ✅");
  };
  el("addPreset").onclick = () => {
    const state = loadState();
    const names = state.fields.map(f=>f.name);
    const add = (name, type, goal=null, inProg=true) => { if(!names.includes(name)) state.fields.push({id:uid(), name, type, goal, inProgress:inProg}); };
    add("Søvn (timer)","number",8,true);
    add("Søvnscore","number",100,true);
    add("Trening","checkbox",null,true);
    add("Lest","checkbox",null,true);
    add("Skole","checkbox",null,true);
    saveState(state); renderAll(); showToast("Forhåndsoppsett lagt til ✅");
  };
  el("resetAll").onclick = () => {
    if(!confirm("Slette alle felter og all data?")) return;
    localStorage.removeItem(LS_KEY);
    renderAll();
    showToast("Alt slettet");
  };
  el("save").onclick = () => {
    const state = loadState();
    const date = el("datePicker").value || todayISO();
    const obj = state.entries[date] ? {...state.entries[date]} : {};
    document.querySelectorAll("[data-id]").forEach(node => {
      const id = node.getAttribute("data-id");
      if(node.type === "checkbox") obj[id] = node.checked; else obj[id] = node.value;
    });
    state.entries[date] = obj; saveState(state);
    renderHistory(); renderKpi(); renderChart(); renderProgress(date); renderGoals(date);
    showToast("Lagret ✅");
  };
  el("export").onclick = () => {
    const state = loadState();
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "livstracker-export-v3.json"; a.click(); URL.revokeObjectURL(a.href);
  };
  el("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0]; if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed.fields || !parsed.entries) throw new Error("Feil format");
      parsed.settings ||= defaultSettings(); parsed.settings.goals ||= [];
      saveState(parsed); renderAll(); showToast("Importert ✅");
    }catch{ showToast("Import feilet"); } finally { e.target.value = ""; }
  });

  function updateDateUI(){
    const iso = el("datePicker").value || todayISO();
    el("datePretty").textContent = prettyDate(iso);
    renderForm(iso); renderProgress(iso); renderGoals(iso);
  }
  el("todayBtn").onclick = () => { el("datePicker").value = todayISO(); updateDateUI(); };
  el("prevDay").onclick = () => { const v = el("datePicker").value || todayISO(); el("datePicker").value = addDays(v, -1); updateDateUI(); };
  el("nextDay").onclick = () => { const v = el("datePicker").value || todayISO(); el("datePicker").value = addDays(v, +1); updateDateUI(); };
  el("datePicker").addEventListener("change", updateDateUI);
  el("openCal").onclick = (e)=>{ e.stopPropagation(); openCal(); };
  document.addEventListener("click",(e)=>{ if(!el("calPop").contains(e.target) && e.target!==el("openCal")) closeCal(); });

  // Goals UI
  el("addGoal").onclick = () => {
    const state = loadState();
    const fieldId = el("goalField").value; if(!fieldId) return;
    const period = el("goalPeriod").value;
    const agg = el("goalAgg").value;
    const target = Number(el("goalTarget").value);
    if(!Number.isFinite(target) || target<=0) return;
    state.settings.goals ||= [];
    state.settings.goals.push({ id: uid(), fieldId, period, agg, target });
    saveState(state); renderGoals(el("datePicker").value || todayISO()); showToast("Mål lagt til ✅");
    el("goalTarget").value = "";
  };

  // Theme UI
  function readSettings(){ return loadState().settings || defaultSettings(); }
  function writeSettings(mut){
    const s = loadState();
    s.settings = {...s.settings, ...mut};
    if(!s.settings.goals) s.settings.goals = [];
    saveState(s); applyTheme(s.settings); renderChart();
  }
  el("themeSel").addEventListener("change",(e)=> writeSettings({ theme: e.target.value }));
  el("bgColor").addEventListener("change",(e)=> writeSettings({ bg: e.target.value }));
  el("accentColor").addEventListener("change",(e)=> writeSettings({ accent: e.target.value }));
  el("themeReset").onclick = ()=> { writeSettings(defaultSettings()); initThemeInputs(); showToast("Tema nullstilt"); };

  function initThemeInputs(){
    const s = readSettings();
    el("themeSel").value = s.theme;
    el("bgColor").value = s.bg;
    el("accentColor").value = s.accent;
  }

  function renderAll(){
    const s = loadState();
    applyTheme(s.settings); initThemeInputs();

    const dp = el("datePicker");
    if(!dp.value) dp.value = todayISO();
    el("datePretty").textContent = prettyDate(dp.value);

    renderFields();
    renderForm(dp.value);
    renderProgress(dp.value);
    renderHistory();
    renderKpi();
    renderChartControls();
    renderChart();
    renderGoalControls();
    renderGoals(dp.value);
  }
  renderAll();
</script>
</body>
</html>
