<!-- /index.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Min livstracker</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --card:#15171d; --muted:#6c7480; --text:#e8eef5; --border:#272a33; --accent:#4f8cff;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text)}
    header{max-width:1040px; margin:24px auto 0; padding:0 16px}
    main{max-width:1040px; margin:12px auto 40px; padding:0 16px}
    h1{margin:0 0 8px; font-size:28px}
    .muted{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr 1.8fr; gap:16px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-weight:600; margin-bottom:6px}
    input,select,button,textarea{padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid var(--border); background:#0f1116; color:var(--text)}
    textarea{width:100%}
    button{cursor:pointer; background:#111520; transition:all .15s ease; border-color:#1e2230}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent); border-color:transparent; color:#fff}
    .btn-danger{background:#6a1216; border-color:#6a1216; color:#fff}
    .btn-ghost{background:transparent}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:700px){.split{grid-template-columns:1fr}}
    .field-card{border:1px dashed var(--border); border-radius:12px; padding:12px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:8px}
    @media (max-width:700px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .item{background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px}
    table{width:100%; border-collapse:collapse; font-size:13px}
    th,td{border-bottom:1px solid var(--border); padding:8px 6px; text-align:left}
    .status{position:fixed; right:16px; bottom:16px; background:#10131b; border:1px solid var(--border); padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(8px); transition:all .2s ease}
    .status.show{opacity:1; transform:none}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#10131b}
  </style>
</head>
<body>
  <header>
    <h1>Min livstracker</h1>
    <div class="muted">Alt lagres lokalt i nettleseren. Ingen konto. Lett å eksportere/importere.</div>
  </header>

  <main class="grid">
    <!-- Venstre: felt & dato/skjema -->
    <section class="card">
      <h2 style="margin:0 0 8px">Felter</h2>
      <div class="muted" style="margin-bottom:8px">Lag felter som “Søvn (timer)”, “Søvnscore”, “Trening”, “Lest”, “Skole”.</div>
      <div class="split">
        <div>
          <label>Navn</label>
          <input id="fName" placeholder="f.eks. Søvn (timer)" />
        </div>
        <div>
          <label>Type</label>
          <select id="fType">
            <option value="number">Tall</option>
            <option value="checkbox">Checkbox</option>
            <option value="text">Tekst</option>
            <option value="textarea">Lang tekst</option>
          </select>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px">
        <button id="addField" class="btn-primary">Legg til felt</button>
        <button id="addPreset" class="pill">Legg til forhåndsoppsett</button>
        <button id="resetAll" class="btn-danger">Slett alt</button>
      </div>

      <div id="fieldList" style="margin-top:14px; display:grid; gap:10px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Før data</h2>
      <div class="row">
        <div>
          <label>Dato</label>
          <input id="datePicker" type="date" />
        </div>
        <button id="todayBtn" class="pill">I dag</button>
      </div>
      <div id="formArea" style="margin-top:12px; display:grid; grid-template-columns:1fr; gap:12px"></div>
      <div class="toolbar" style="margin-top:12px">
        <button id="save" class="btn-primary">Lagre</button>
        <button id="export" class="pill">Eksporter JSON</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>
    </section>

    <!-- Høyre: graf & historikk -->
    <section class="card">
      <h2 style="margin:0 0 8px">Graf</h2>
      <div class="split">
        <div>
          <label>Felt</label>
          <select id="chartField"></select>
        </div>
        <div>
          <label>Periode</label>
          <select id="chartRange">
            <option value="week">Uke</option>
            <option value="month" selected>Måned</option>
            <option value="year">År</option>
            <option value="all">Alt</option>
          </select>
        </div>
      </div>
      <div class="split" style="margin-top:10px">
        <div>
          <label>Aggregasjon</label>
          <select id="chartAgg">
            <option value="avg" selected>Snitt</option>
            <option value="sum">Sum</option>
          </select>
        </div>
        <div>
          <label>Gruppering</label>
          <select id="chartGroup">
            <option value="auto" selected>Auto</option>
            <option value="day">Dag</option>
            <option value="week">Uke</option>
            <option value="month">Måned</option>
          </select>
        </div>
      </div>
      <div style="margin-top:14px">
        <canvas id="chart" height="160"></canvas>
      </div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Historikk (siste 14 dager)</h2>
      <div id="history"></div>

      <div class="kpi">
        <div class="item"><div class="muted">Dager ført</div><div id="kpiDays" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Felt</div><div id="kpiFields" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Nyeste dato</div><div id="kpiLatest" style="font-size:18px; font-weight:700">–</div></div>
        <div class="item"><div class="muted">Versjon</div><div style="font-size:18px; font-weight:700">v2</div></div>
      </div>
    </section>
  </main>

  <div id="status" class="status"></div>

<script>
  // ---- Lagring/state ----
  const LS_KEY = "life_tracker_v2";

  const el = (id) => document.getElementById(id);
  const todayISO = () => new Date().toLocaleDateString("sv-SE"); // yyyy-mm-dd

  function loadState(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        // migrasjon fra v1 (din gamle struktur)
        const oldRaw = localStorage.getItem("my_tracker_v1");
        if(oldRaw){
          try{
            const old = JSON.parse(oldRaw);
            const entries = {};
            if(old.data && Object.keys(old.data).length){
              entries[todayISO()] = {...old.data};
            }
            const s = { fields: old.fields || [], entries };
            saveState(s);
            return s;
          }catch{ /* stilletiende */ }
        }
        const s = { fields: [], entries: {} };
        saveState(s);
        return s;
      }
      const parsed = JSON.parse(raw);
      // sikring av nøkler
      parsed.fields ||= [];
      parsed.entries ||= {};
      return parsed;
    }catch{
      const s = { fields: [], entries: {} };
      saveState(s);
      return s;
    }
  }
  function saveState(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
  }

  // ---- Utils ----
  const escapeHtml = (s) => String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const escapeAttr = (s) => escapeHtml(s).replaceAll("\n","&#10;");
  const uid = () => "f_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  const toNumber = (v) => {
    if (typeof v === "number") return v;
    if (typeof v === "boolean") return v ? 1 : 0;
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  };
  const showToast = (msg) => {
    const node = el("status");
    node.textContent = msg;
    node.classList.add("show");
    setTimeout(()=> node.classList.remove("show"), 1200);
  };

  // ---- Render feltliste ----
  function renderFields(){
    const state = loadState();
    const wrap = el("fieldList");
    wrap.innerHTML = "";
    if(!state.fields.length){
      wrap.innerHTML = `<div class="muted">Ingen felter enda.</div>`;
      return;
    }
    state.fields.forEach((f, idx) => {
      const card = document.createElement("div");
      card.className = "field-card row";
      card.style.justifyContent = "space-between";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(f.name)}</div><div class="muted" style="font-size:12px">${f.type}</div>`;
      const right = document.createElement("div");
      const del = document.createElement("button");
      del.className = "btn-danger";
      del.textContent = "Fjern";
      del.onclick = () => {
        const s = loadState();
        const removed = s.fields.splice(idx,1)[0];
        if(removed){
          // fjern data for alle dager
          Object.keys(s.entries).forEach(d => { if(s.entries[d]) delete s.entries[d][removed.id]; });
        }
        saveState(s);
        renderAll();
      };
      right.appendChild(del);
      card.appendChild(left);
      card.appendChild(right);
      wrap.appendChild(card);
    });
  }

  // ---- Render skjema for valgt dato ----
  function renderForm(dateISO){
    const state = loadState();
    const form = el("formArea");
    form.innerHTML = "";

    if(!state.fields.length){
      form.innerHTML = `<div class="muted">Legg til felter over for å kunne føre.</div>`;
      return;
    }

    const dayData = state.entries[dateISO] || {};
    state.fields.forEach(f => {
      const block = document.createElement("div");
      block.className = "card";
      block.style.padding = "12px";
      block.style.background = "#0f1116";

      const label = document.createElement("div");
      label.style.fontWeight = "700";
      label.style.marginBottom = "8px";
      label.textContent = f.name;

      let inputHtml = "";
      const val = dayData[f.id];

      if(f.type === "text"){
        inputHtml = `<input data-id="${f.id}" type="text" value="${escapeAttr(val ?? "")}" />`;
      } else if(f.type === "number"){
        inputHtml = `<input data-id="${f.id}" type="number" inputmode="decimal" step="any" value="${escapeAttr(val ?? "")}" />`;
      } else if(f.type === "checkbox"){
        const checked = !!val;
        inputHtml = `<label class="row" style="align-items:center; gap:8px"><input data-id="${f.id}" type="checkbox" ${checked ? "checked":""} /> <span class="muted">Huket av</span></label>`;
      } else {
        inputHtml = `<textarea data-id="${f.id}" rows="4">${escapeHtml(val ?? "")}</textarea>`;
      }

      block.appendChild(label);
      const field = document.createElement("div");
      field.innerHTML = inputHtml;
      block.appendChild(field);
      form.appendChild(block);
    });
  }

  // ---- Historikk (siste 14 dager) ----
  function renderHistory(){
    const state = loadState();
    const historyEl = el("history");
    const dates = Object.keys(state.entries).sort(); // ISO
    const last = dates.slice(-14);
    if(!last.length){
      historyEl.innerHTML = `<div class="muted">Ingen historikk enda.</div>`;
      return;
    }
    const fieldNames = Object.fromEntries(state.fields.map(f => [f.id, f.name]));
    const visibleFields = state.fields.filter(f => f.type !== "textarea"); // kort tabell
    let html = `<div style="overflow:auto"><table><thead><tr><th>Dato</th>${
      visibleFields.map(f => `<th>${escapeHtml(f.name)}</th>`).join("")
    }</tr></thead><tbody>`;
    last.forEach(d => {
      const row = state.entries[d] || {};
      html += `<tr><td>${d}</td>${
        visibleFields.map(f => {
          const v = row[f.id];
          if (f.type === "checkbox") return `<td>${v ? "✅" : "—"}</td>`;
          return `<td>${v ?? "—"}</td>`;
        }).join("")
      }</tr>`;
    });
    html += `</tbody></table></div>`;
    historyEl.innerHTML = html;
  }

  // ---- KPI ----
  function renderKpi(){
    const state = loadState();
    const days = Object.keys(state.entries).length;
    const latest = Object.keys(state.entries).sort().slice(-1)[0] || "—";
    el("kpiDays").textContent = String(days);
    el("kpiFields").textContent = String(state.fields.length);
    el("kpiLatest").textContent = latest;
  }

  // ---- Chart ----
  let chart;
  function renderChartControls(){
    const state = loadState();
    const chartField = el("chartField");
    const eligible = state.fields.filter(f => f.type === "number" || f.type === "checkbox");
    chartField.innerHTML = eligible.length
      ? eligible.map(f => `<option value="${f.id}">${escapeHtml(f.name)}</option>`).join("")
      : `<option disabled>Ingen tall/checkbox-felt</option>`;
  }

  function groupKey(date, mode){
    const d = new Date(date + "T00:00:00");
    if(mode === "day"){ return date; }
    if(mode === "week"){
      // ISO uke: mandag som første dag
      const tmp = new Date(d);
      const day = (tmp.getDay() + 6) % 7; // 0=Mon
      tmp.setDate(tmp.getDate() - day);
      const year = tmp.getFullYear();
      // uke nummer
      const jan4 = new Date(year,0,4);
      const jan4Day = (jan4.getDay()+6)%7;
      const weekStart = new Date(tmp);
      const diff = Math.round((weekStart - (new Date(year,0,4 - jan4Day)))/86400000);
      const week = Math.floor(diff/7)+1;
      return `${year}-U${String(week).padStart(2,"0")}`;
    }
    if(mode === "month"){
      return date.slice(0,7); // yyyy-mm
    }
    return date;
  }

  function inferGroup(range){
    if(range === "week") return "day";
    if(range === "month") return "day";
    if(range === "year") return "month";
    return "month"; // alt
  }

  function computeDateRange(range){
    const end = new Date(); end.setHours(0,0,0,0);
    const start = new Date(end);
    if(range === "week") start.setDate(end.getDate()-6);
    else if(range === "month") start.setMonth(end.getMonth()-1);
    else if(range === "year") start.setFullYear(end.getFullYear()-1);
    else start.setFullYear(end.getFullYear()-5); // alt = siste 5 år som default visning
    const sIso = start.toLocaleDateString("sv-SE");
    const eIso = end.toLocaleDateString("sv-SE");
    return [sIso, eIso];
  }

  function renderChart(){
    const state = loadState();
    const cf = el("chartField").value;
    if(!cf){ drawEmpty(); return; }
    const range = el("chartRange").value;
    const agg = el("chartAgg").value;
    const groupSel = el("chartGroup").value;
    const [from, to] = computeDateRange(range);

    const entries = Object.entries(state.entries)
      .filter(([d]) => d >= from && d <= to)
      .sort(([a],[b]) => a.localeCompare(b));

    const numeric = entries.map(([d, obj]) => {
      const f = state.fields.find(x => x.id === cf);
      const raw = obj?.[cf];
      const val = f?.type === "checkbox" ? (raw ? 1 : 0) : toNumber(raw);
      return [d, val, !!(raw ?? false)];
    });

    const grpMode = groupSel === "auto" ? inferGroup(range) : groupSel;
    const groups = new Map();
    for(const [d,v,has] of numeric){
      const key = groupKey(d, grpMode);
      if(!groups.has(key)) groups.set(key, {sum:0, count:0});
      const g = groups.get(key);
      if(has){ g.sum += v; g.count += 1; } // ikke tell tomme dager
    }
    // labels i sortert rekkefølge
    const labels = Array.from(groups.keys()).sort((a,b)=>a.localeCompare(b));
    const data = labels.map(k => {
      const g = groups.get(k);
      if(agg === "sum") return g.sum;
      return g.count ? g.sum / g.count : 0;
    });

    const ctx = el("chart").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets: [{ label: state.fields.find(f=>f.id===cf)?.name || "Verdi", data, tension:.3, fill:false }]},
      options: {
        responsive:true,
        scales:{
          x:{ grid:{ color:"rgba(255,255,255,.05)"} },
          y:{ grid:{ color:"rgba(255,255,255,.05)"}, beginAtZero:true }
        },
        plugins:{
          legend:{ labels:{ color:"#cfd8e3" } },
          tooltip:{ mode:"index", intersect:false }
        }
      }
    });
  }
  function drawEmpty(){
    const ctx = el("chart").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, { type:"line", data:{labels:[], datasets:[{label:"", data:[]}]}, options:{} });
  }

  // ---- Handlers ----
  el("addField").onclick = () => {
    const name = el("fName").value.trim();
    const type = el("fType").value;
    if(!name) return;
    const state = loadState();
    state.fields.push({ id: uid(), name, type });
    saveState(state);
    el("fName").value = "";
    renderAll();
    showToast("Felt lagt til ✅");
  };

  el("addPreset").onclick = () => {
    const state = loadState();
    const names = state.fields.map(f=>f.name);
    const add = (name, type) => { if(!names.includes(name)) state.fields.push({id:uid(), name, type}); };
    add("Søvn (timer)","number");
    add("Søvnscore","number");
    add("Trening","checkbox");
    add("Lest","checkbox");
    add("Skole","checkbox");
    saveState(state);
    renderAll();
    showToast("Forhåndsoppsett lagt til ✅");
  };

  el("resetAll").onclick = () => {
    if(!confirm("Slette alle felter og all data?")) return;
    localStorage.removeItem(LS_KEY);
    renderAll();
    showToast("Alt slettet");
  };

  el("save").onclick = () => {
    const state = loadState();
    const date = el("datePicker").value || todayISO();
    const obj = state.entries[date] ? {...state.entries[date]} : {};
    document.querySelectorAll("[data-id]").forEach(node => {
      const id = node.getAttribute("data-id");
      if(node.type === "checkbox") obj[id] = node.checked;
      else obj[id] = node.value;
    });
    state.entries[date] = obj;
    saveState(state);
    renderHistory();
    renderKpi();
    renderChart();
    showToast("Lagret ✅");
  };

  el("export").onclick = () => {
    const state = loadState();
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "livstracker-export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  };

  el("importFile").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const parsed = JSON.parse(text);
      if(!parsed.fields || !parsed.entries) throw new Error("Feil format");
      saveState(parsed);
      renderAll();
      showToast("Importert ✅");
    }catch{
      showToast("Import feilet");
    } finally {
      e.target.value = "";
    }
  });

  el("todayBtn").onclick = () => {
    el("datePicker").value = todayISO();
    renderForm(el("datePicker").value);
  };

  // Chart control changes
  ["chartField","chartRange","chartAgg","chartGroup"].forEach(id => {
    el(id).addEventListener("change", renderChart);
  });

  // ---- Init / render all ----
  function renderAll(){
    const dp = el("datePicker");
    if(!dp.value) dp.value = todayISO();
    renderFields();
    renderForm(dp.value);
    renderHistory();
    renderKpi();
    renderChartControls();
    renderChart();
  }

  // init
  renderAll();
</script>
</body>
</html>
