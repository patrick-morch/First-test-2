<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Min livstracker</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b0c10; --card:#15171d; --muted:#6c7480; --text:#e8eef5; --border:#272a33; --accent:#4f8cff;
      --ring-bg:#0f1116;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; margin:0; background:var(--bg); color:var(--text)}
    header{max-width:1100px; margin:24px auto 0; padding:0 16px}
    main{max-width:1100px; margin:12px auto 44px; padding:0 16px}
    h1{margin:0 0 8px; font-size:28px}
    .muted{color:var(--muted); font-size:13px}
    .grid{display:grid; grid-template-columns: 1.2fr 1.8fr; gap:16px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end}
    label{display:block; font-weight:600; margin-bottom:6px}
    input,select,button,textarea{padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid var(--border); background:#0f1116; color:var(--text)}
    textarea{width:100%}
    button{cursor:pointer; background:#111520; transition:all .15s ease; border-color:#1e2230}
    button:hover{transform:translateY(-1px)}
    .btn-primary{background:var(--accent); border-color:transparent; color:#fff}
    .btn-danger{background:#6a1216; border-color:#6a1216; color:#fff}
    .pill{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#10131b}
    .split{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:700px){.split{grid-template-columns:1fr}}
    .field-card{border:1px dashed var(--border); border-radius:12px; padding:12px}
    .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:8px}
    @media (max-width:700px){.kpi{grid-template-columns:repeat(2,1fr)}}
    .kpi .item{background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px}

    /* Kalender */
    .calendar{position:relative; display:inline-block}
    .cal-pop{position:absolute; z-index:50; top:42px; left:0; background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px; width:280px; box-shadow:0 10px 30px rgba(0,0,0,.4)}
    .cal-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .cal-cell{padding:8px 0; text-align:center; border:1px solid var(--border); border-radius:8px; cursor:pointer; user-select:none}
    .cal-cell.muted{opacity:.5}
    .cal-cell.sel{outline:2px solid var(--accent)}
    .cal-cell.good{background:rgba(0,255,0,.08); border-color:rgba(0,255,0,.25)}
    .cal-cell.bad{background:rgba(255,0,0,.06); border-color:rgba(255,0,0,.2)}
    .cal-dow{font-size:11px; text-align:center; color:var(--muted)}

    .status{position:fixed; right:16px; bottom:16px; background:#10131b; border:1px solid var(--border); padding:10px 12px; border-radius:10px; opacity:0; transform:translateY(8px); transition:all .2s ease}
    .status.show{opacity:1; transform:none}
    .badge{padding:4px 8px; border:1px solid var(--border); border-radius:999px; background:#10131b; font-size:12px}
    .list{display:grid; gap:8px}
    .list .rowline{display:flex; justify-content:space-between; align-items:center; gap:10px; background:#0f1116; border:1px solid var(--border); border-radius:10px; padding:8px 10px}

    .hearts{font-size:26px; letter-spacing:2px}

    /* Graffelt-liste */
    #chartFields{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px; max-height:140px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; background:#0f1116}
    @media (max-width:700px){#chartFields{grid-template-columns:1fr}}
    .cf-item{display:flex; align-items:center; gap:8px; font-size:13px}

    /* Historikk tabell – mer luft + sticky header + zebra */
    .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:var(--card); z-index:1; border-bottom:1px solid var(--border)}
    th,td{padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap}
    tbody tr:nth-child(odd){background:rgba(255,255,255,0.02)}
    tbody tr:hover{background:rgba(255,255,255,0.04)}
    .cell-center{text-align:center}

    /* Historikk kort (mobil) */
    @media (max-width:720px){
      .table-wrap{display:none}
      .history-cards{display:grid; gap:10px}
      .hc{background:#0f1116; border:1px solid var(--border); border-radius:12px; padding:10px}
      .hc h4{margin:0 0 6px 0}
      .hc .kv{display:grid; grid-template-columns:1fr 1fr; gap:6px 10px; font-size:13px}
      .kv div{display:flex; justify-content:space-between; gap:8px}
      .kv b{color:var(--muted); font-weight:600}
    }
    @media (min-width:721px){ .history-cards{display:none} }

    /* Tema presets */
    .theme-row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .preset{display:flex; gap:8px; align-items:center; border:1px solid var(--border); border-radius:12px; padding:6px 8px; background:#0f1116; cursor:pointer}
    .swatch{width:28px; height:20px; border-radius:6px; border:1px solid var(--border); position:relative; overflow:hidden}
    .swatch i{position:absolute; inset:0}
    .preview-card{margin-top:8px; padding:10px; border:1px dashed var(--border); border-radius:12px; background:var(--bg); color:var(--text)}
  </style>
</head>
<body>
  <header>
    <h1>Min livstracker</h1>
    <div class="muted">Alt lagres lokalt. Tema og farger kan tilpasses. Dato velges fra kalender.</div>
  </header>

  <main class="grid">
    <!-- Venstre: felter, dato, skjema -->
    <section class="card">
      <h2 style="margin:0 0 8px">Felter</h2>
      <div class="split">
        <div>
          <label>Navn</label>
          <input id="fName" placeholder="f.eks. Søvn (timer)" />
        </div>
        <div>
          <label>Type</label>
          <select id="fType">
            <option value="number">Tall</option>
            <option value="checkbox">Checkbox</option>
            <option value="text">Tekst</option>
            <option value="textarea">Lang tekst</option>
          </select>
        </div>
      </div>
      <div class="split" style="margin-top:8px">
        <div>
          <label>Mål (kun for tall)</label>
          <input id="fGoal" type="number" inputmode="decimal" step="any" placeholder="f.eks. 8" />
        </div>
        <div class="row" style="align-items:center; margin-top:28px">
          <input id="fInProg" type="checkbox" checked />
          <label for="fInProg" style="margin:0">Ta med i fremdrift</label>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="addField" class="btn-primary">Legg til felt</button>
        <button id="addPreset" class="pill">Forhåndsoppsett</button>
        <button id="resetAll" class="btn-danger">Slett alt</button>
      </div>

      <div id="fieldList" style="margin-top:14px; display:grid; gap:10px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Før data</h2>
      <div class="row" style="align-items:center">
        <div class="calendar">
          <label for="datePicker">Dato</label>
          <div class="row" style="align-items:center">
            <input id="datePicker" type="date" />
            <button id="openCal" title="Åpne kalender" class="pill">Kalender</button>
          </div>
          <div id="calPop" class="cal-pop" style="display:none"></div>
        </div>
        <button id="prevDay" class="pill">← Forrige</button>
        <button id="todayBtn" class="pill">I dag</button>
        <button id="nextDay" class="pill">Neste →</button>
        <span id="datePretty" class="badge"></span>
      </div>

      <div id="formArea" style="margin-top:12px; display:grid; grid-template-columns:1fr; gap:12px"></div>
      <div class="row" style="margin-top:12px">
        <button id="save" class="btn-primary">Lagre</button>
        <button id="export" class="pill">Eksporter JSON</button>
        <input id="importFile" type="file" accept="application/json" />
      </div>
    </section>

    <!-- Høyre: dagens oversikt, graf, historikk, tema -->
    <section class="card">
      <h2 style="margin:0 0 8px">Dagens oversikt</h2>
      <div class="row" style="align-items:center; gap:14px">
        <div id="hearts" class="hearts">♡</div>
        <div id="heartsText" style="font-size:18px; font-weight:700">0/0 (0%)</div>
      </div>
      <div id="progressList" class="list" style="margin-top:10px"></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Graf</h2>
      <div class="split">
        <div>
          <label>Felt (flervalg)</label>
          <div id="chartFields"></div>
          <div class="row" style="margin-top:6px">
            <button id="cfAll" class="pill">Velg alle</button>
            <button id="cfNone" class="pill">Tøm</button>
          </div>
        </div>
        <div>
          <label>Periode</label>
          <select id="chartRange">
            <option value="week">Uke</option>
            <option value="month" selected>Måned</option>
            <option value="year">År</option>
            <option value="all">Alt</option>
          </select>
          <div class="split" style="margin-top:10px">
            <div>
              <label>Aggregasjon</label>
              <select id="chartAgg">
                <option value="avg" selected>Snitt</option>
                <option value="sum">Sum</option>
              </select>
            </div>
            <div>
              <label>Gruppering</label>
              <select id="chartGroup">
                <option value="auto" selected>Auto</option>
                <option value="day">Dag</option>
                <option value="week">Uke</option>
                <option value="month">Måned</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:14px"><canvas id="chart" height="190"></canvas></div>

      <hr style="border:none; border-top:1px solid var(--border); margin:16px 0">
      <h2 style="margin:0 0 8px">Historikk (siste 14 dager)</h2>
      <div class="table-wrap" id="historyTable"></div>
      <div class="history-cards" id="historyCards"></div>

      <div class="kpi" style="margin-top:12px">
        <div class="item"><div class="muted">Dager ført</div><div id="kpiDays" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Felt</div><div id="kpiFields" style="font-size:18px; font-weight:700">0</div></div>
        <div class="item"><div class="muted">Nyeste dato</div><div id="kpiLatest" style="font-size:18px; font-weight:700">–</div></div>
        <div class="item">
          <div class="muted">Tema & farger</div>
          <div class="theme-row" style="margin-top:6px">
            <button class="preset" data-preset="dark"  title="Mørk"><span class="swatch"><i style="background:linear-gradient(90deg,#0b0c10 50%, #4f8cff 50%)"></i></span> Mørk</button>
            <button class="preset" data-preset="light" title="Lys"><span class="swatch"><i style="background:linear-gradient(90deg,#f7f7f9 50%, #4f8cff 50%)"></i></span> Lys</button>
            <button class="preset" data-preset="emerald" title="Emerald"><span class="swatch"><i style="background:linear-gradient(90deg,#06110f 50%, #10b981 50%)"></i></span> Emerald</button>
            <button class="preset" data-preset="solar" title="Solar"><span class="swatch"><i style="background:linear-gradient(90deg,#0d0f10 50%, #f59e0b 50%)"></i></span> Solar</button>
          </div>
          <div class="split" style="margin-top:8px">
            <div>
              <label>Bakgrunnsfarge</label>
              <input id="bgColor" type="color" title="Endrer bakgrunn" />
              <div class="muted">Endrer siden sin bakgrunn.</div>
            </div>
            <div>
              <label>Aksentfarge</label>
              <input id="accentColor" type="color" title="Endrer aksent (knapper/graf)" />
              <div class="muted">Brukes på knapper og graf.</div>
            </div>
          </div>
          <div class="preview-card" id="themePreview">
            <div style="font-weight:700; margin-bottom:4px">Forhåndsvisning</div>
            <div class="row" style="align-items:center">
              <button class="btn-primary">Primær knapp</button>
              <span class="badge">Badge</span>
              <span class="muted">Tekst</span>
            </div>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="themeReset" class="pill">Nullstill</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="status" class="status"></div>

<script>
  /* ---------------- State & tema ---------------- */
  const LS_KEY = "life_tracker_v3";
  const el = (id) => document.getElementById(id);
  const todayISO = () => new Date().toLocaleDateString("sv-SE");
  const MONTHS = ["jan","feb","mar","apr","mai","jun","jul","aug","sep","okt","nov","des"];
  const prettyDate = (iso)=>{ if(!iso) return "—"; const [y,m,d]=iso.split("-").map(Number); return `${d}. ${MONTHS[(m||1)-1]}, ${y}`; };
  const defaultSettings = ()=>({ theme:"dark", bg:"#0b0c10", accent:"#4f8cff" });

  function loadState(){
    try{ const raw = localStorage.getItem(LS_KEY);
      if(raw){ const s = JSON.parse(raw); s.fields ||= []; s.entries ||= {}; s.settings ||= defaultSettings(); return s; }
    }catch{}
    const s = { fields: [], entries: {}, settings: defaultSettings() }; saveState(s); return s;
  }
  function saveState(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

  function applyTheme(settings){
    const root=document.documentElement, t=settings.theme||"dark"; let bg=settings.bg|| (t==="light"?"#f7f7f9":"#0b0c10");
    const accent=settings.accent||"#4f8cff";
    if(t==="dark"){ root.style.setProperty("--bg",bg); root.style.setProperty("--card","#15171d"); root.style.setProperty("--text","#e8eef5"); root.style.setProperty("--muted","#6c7480"); root.style.setProperty("--border","#272a33"); root.style.setProperty("--ring-bg","#0f1116"); }
    else if(t==="light"){ root.style.setProperty("--bg",bg); root.style.setProperty("--card","#ffffff"); root.style.setProperty("--text","#101317"); root.style.setProperty("--muted","#5f6b7a"); root.style.setProperty("--border","#e5e7eb"); root.style.setProperty("--ring-bg","#ffffff"); }
    else if(t==="emerald"){ bg=settings.bg||"#06110f"; root.style.setProperty("--bg",bg); root.style.setProperty("--card","#0d1917"); root.style.setProperty("--text","#e6fff9"); root.style.setProperty("--muted","#89a39b"); root.style.setProperty("--border","#1f2b28"); root.style.setProperty("--ring-bg","#0d1917"); }
    else if(t==="solar"){ bg=settings.bg||"#0d0f10"; root.style.setProperty("--bg",bg); root.style.setProperty("--card","#14181b"); root.style.setProperty("--text","#f2efe6"); root.style.setProperty("--muted","#c2c0b5"); root.style.setProperty("--border","#2b2f31"); root.style.setProperty("--ring-bg","#14181b"); }
    root.style.setProperty("--accent", accent);
    // Mini live preview tar samme variabler – ingen ekstra kode nødvendig
  }

  /* ---------------- Utils ---------------- */
  const escapeHtml = (s)=>String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  const escapeAttr = (s)=>escapeHtml(s).replaceAll("\n","&#10;");
  const uid = ()=>"id_"+Math.random().toString(16).slice(2)+Date.now().toString(16);
  const toNumber = (v)=>{ if(typeof v==="number") return v; if(typeof v==="boolean") return v?1:0; const n=Number(v); return Number.isFinite(n)?n:0; };
  const showToast = (msg)=>{ const node=el("status"); node.textContent=msg; node.classList.add("show"); setTimeout(()=> node.classList.remove("show"), 1200); };

  /* ---------------- Felter ---------------- */
  function renderFields(){
    const state = loadState(); const wrap = el("fieldList"); wrap.innerHTML = state.fields.length? "": `<div class="muted">Ingen felter enda.</div>`;
    state.fields.forEach((f, idx)=>{
      const card=document.createElement("div"); card.className="field-card";
      const top=document.createElement("div"); top.className="row"; top.style.justifyContent="space-between";
      const left=document.createElement("div");
      left.innerHTML = `<div style="font-weight:700">${escapeHtml(f.name)}</div><div class="muted" style="font-size:12px">${f.type}${f.type==="number"&&f.goal?` • mål: ${f.goal}`:""}${f.inProgress?" • i fremdrift":""}</div>`;
      const del=document.createElement("button"); del.className="btn-danger"; del.textContent="Fjern";
      del.onclick=()=>{ const s=loadState(); const removed=s.fields.splice(idx,1)[0]; if(removed){ Object.keys(s.entries).forEach(d=>{ if(s.entries[d]) delete s.entries[d][removed.id]; }); } saveState(s); renderAll(); };
      top.appendChild(left); top.appendChild(del);

      const edit=document.createElement("div"); edit.className="row";
      edit.innerHTML = `
        <input class="pill" data-edit="name" style="min-width:220px" value="${escapeAttr(f.name)}" />
        ${f.type==="number"?`<input class="pill" data-edit="goal" type="number" step="any" placeholder="Mål" value="${f.goal ?? ""}" />`:""}
        <label class="row" style="align-items:center; gap:6px"><input data-edit="inProgress" type="checkbox" ${f.inProgress?"checked":""}/> I fremdrift</label>
        <button class="pill" data-edit="save">Oppdater</button>
      `;
      edit.querySelector('[data-edit="save"]').onclick=()=>{
        const s=loadState(); const item=s.fields[idx]; if(!item) return;
        const name=edit.querySelector('[data-edit="name"]').value.trim(); if(name) item.name=name;
        if(item.type==="number"){ const g=edit.querySelector('[data-edit="goal"]').value.trim(); item.goal=g?Number(g):null; }
        item.inProgress=edit.querySelector('[data-edit="inProgress"]').checked;
        saveState(s); renderAll(); showToast("Felt oppdatert");
      };
      card.appendChild(top); card.appendChild(edit); wrap.appendChild(card);
    });
  }

  /* ---------------- Skjema ---------------- */
  function renderForm(dateISO){
    const state = loadState(); const form = el("formArea"); form.innerHTML="";
    if(!state.fields.length){ form.innerHTML=`<div class="muted">Legg til felter over for å kunne føre.</div>`; return; }
    const dayData = state.entries[dateISO] || {};
    state.fields.forEach(f=>{
      const block=document.createElement("div"); block.className="card"; block.style.padding="12px"; block.style.background="#0f1116";
      const label=document.createElement("div"); label.style.fontWeight="700"; label.style.marginBottom="8px"; label.textContent=f.name;
      let html=""; const val=dayData[f.id];
      if(f.type==="text"){ html=`<input data-id="${f.id}" type="text" value="${escapeAttr(val ?? "")}" />`; }
      else if(f.type==="number"){ html=`<input data-id="${f.id}" type="number" inputmode="decimal" step="any" value="${escapeAttr(val ?? "")}" />`; }
      else if(f.type==="checkbox"){ html=`<label class="row" style="align-items:center; gap:8px"><input data-id="${f.id}" type="checkbox" ${val? "checked":""}/> <span class="muted">Huket av</span></label>`; }
      else { html=`<textarea data-id="${f.id}" rows="4">${escapeHtml(val ?? "")}</textarea>`; }
      block.appendChild(label); const field=document.createElement("div"); field.innerHTML=html; block.appendChild(field); form.appendChild(block);
    });
  }

  /* ---------------- Dagens oversikt (hjerter) ---------------- */
  function computeDailyHearts(dateISO){
    const state = loadState(); const day = state.entries[dateISO] || {};
    let total=0, ok=0; const rows=[];
    state.fields.forEach(f=>{
      if(!f.inProgress) return;
      if(f.type==="checkbox"){
        total+=1; const hit = day[f.id]===true; if(hit) ok+=1;
        rows.push({name:f.name, ok:hit, detail: hit?"oppnådd":"ikke"});
      }else if(f.type==="number" && Number(f.goal||0)>0){
        total+=1; const v=toNumber(day[f.id]); const hit = v>=Number(f.goal); if(hit) ok+=1;
        rows.push({name:f.name, ok:hit, detail: (day[f.id]??"—")+` / mål ${f.goal}`});
      }
    });
    const pct = total? Math.round((ok/total)*100):0;
    return {ok,total,pct,rows};
  }
  function renderHearts(dateISO){
    const {ok,total,pct,rows} = computeDailyHearts(dateISO);
    const heartsMax = Math.min(ok,10);
    const heartsStr = "❤️".repeat(heartsMax) + (ok>10?` +${ok-10}`:"");
    el("hearts").textContent = heartsStr || "♡";
    el("heartsText").textContent = `${ok}/${total} (${pct}%)`;
    const list = el("progressList"); list.innerHTML="";
    if(!rows.length){ list.innerHTML = `<div class="muted">Ingen mål-aktiverte felt i dag. Slå på “I fremdrift” og legg mål for tallfelt.</div>`; return; }
    rows.forEach(r=>{
      const row=document.createElement("div"); row.className="rowline";
      row.innerHTML = `<div style="font-weight:700">${escapeHtml(r.name)}</div><div class="muted" style="font-size:12px">${escapeHtml(r.detail)}</div><div>${r.ok?"❤️":"♡"}</div>`;
      list.appendChild(row);
    });
  }

  /* ---------------- Historikk (14 dager – tabell + kort) ---------------- */
  function renderHistory(){
    const state=loadState();
    const dates=Object.keys(state.entries).sort(); const last=dates.slice(-14);
    const visibleFields=state.fields.filter(f => f.type!=="textarea");
    const tblWrap = el("historyTable"); const cardsWrap = el("historyCards");
    tblWrap.innerHTML = ""; cardsWrap.innerHTML = "";

    if(!last.length){
      tblWrap.innerHTML = `<div class="muted" style="padding:8px 10px">Ingen historikk enda.</div>`;
      return;
    }

    // Desktop tabell
    let html = `<div class="table-wrap"><table><thead><tr><th>Dato</th>${
      visibleFields.map(f=>`<th>${escapeHtml(f.name)}</th>`).join("")
    }</tr></thead><tbody>`;
    last.forEach(d=>{
      const row = state.entries[d] || {};
      html += `<tr><td>${prettyDate(d)}</td>${
        visibleFields.map(f=>{
          const v=row[f.id];
          if(f.type==="checkbox") return `<td class="cell-center">${v?"✅":"—"}</td>`;
          return `<td>${v ?? "—"}</td>`;
        }).join("")
      }</tr>`;
    });
    html += `</tbody></table></div>`;
    tblWrap.innerHTML = html;

    // Mobil kort
    last.forEach(d=>{
      const day = state.entries[d] || {};
      const card = document.createElement("div");
      card.className = "hc";
      card.innerHTML = `<h4>${prettyDate(d)}</h4>`;
      const kv = document.createElement("div"); kv.className="kv";
      visibleFields.forEach(f=>{
        let val = "—";
        if(f.type==="checkbox") val = day[f.id] ? "✅" : "—";
        else val = (day[f.id] ?? "—");
        const row = document.createElement("div");
        row.innerHTML = `<b>${escapeHtml(f.name)}</b><span>${escapeHtml(val)}</span>`;
        kv.appendChild(row);
      });
      card.appendChild(kv); cardsWrap.appendChild(card);
    });
  }

  /* ---------------- KPI ---------------- */
  function renderKpi(){
    const state=loadState();
    const days=Object.keys(state.entries).length;
    const latest=Object.keys(state.entries).sort().slice(-1)[0] || "—";
    el("kpiDays").textContent=String(days);
    el("kpiFields").textContent=String(state.fields.length);
    el("kpiLatest").textContent= latest==="—" ? "—" : prettyDate(latest);
  }

  /* ---------------- Graf (flere serier + sekundær y-akse) ---------------- */
  let chart;
  function eligibleFields(){ return loadState().fields.filter(f=>f.type==="number"||f.type==="checkbox"); }
  function renderChartControls(){
    const wrap = el("chartFields"); wrap.innerHTML = "";
    const fields = eligibleFields();
    if(!fields.length){ wrap.innerHTML = `<div class="muted">Ingen tall/checkbox-felt</div>`; return; }
    fields.forEach(f=>{
      const id = "cf_"+f.id;
      const div = document.createElement("label"); div.className="cf-item";
      div.innerHTML = `<input type="checkbox" id="${id}" data-fid="${f.id}" checked> <span>${escapeHtml(f.name)}</span>`;
      wrap.appendChild(div);
      div.querySelector("input").addEventListener("change", renderChart);
    });
    el("cfAll").onclick = ()=>{ wrap.querySelectorAll('input[type="checkbox"]').forEach(c=>{ c.checked=true; }); renderChart(); };
    el("cfNone").onclick = ()=>{ wrap.querySelectorAll('input[type="checkbox"]').forEach(c=>{ c.checked=false; }); renderChart(); };
  }
  function getSelectedFieldIds(){
    return Array.from(el("chartFields").querySelectorAll('input[type="checkbox"]:checked')).map(n=>n.getAttribute("data-fid"));
  }
  function groupKey(date, mode){
    const d=new Date(date+"T00:00:00");
    if(mode==="day") return prettyDate(date);
    if(mode==="week"){
      const tmp=new Date(d); const day=(tmp.getDay()+6)%7; tmp.setDate(tmp.getDate()-day);
      const year=tmp.getFullYear(); const jan4=new Date(year,0,4); const jan4Day=(jan4.getDay()+6)%7;
      const weekStart=new Date(tmp);
      const diff=Math.round((weekStart-(new Date(year,0,4-jan4Day)))/86400000);
      const week=Math.floor(diff/7)+1;
      return `Uke ${String(week).padStart(2,"0")} ${year}`;
    }
    if(mode==="month"){ const [y,m]=date.split("-").map(Number); return `${MONTHS[(m||1)-1]} ${y}`; }
    return prettyDate(date);
  }
  function inferGroup(range){ if(range==="week")return"day"; if(range==="month")return"day"; if(range==="year")return"month"; return"month"; }
  function computeDateRange(range){
    const end=new Date(); end.setHours(0,0,0,0); const start=new Date(end);
    if(range==="week") start.setDate(end.getDate()-6);
    else if(range==="month") start.setMonth(end.getMonth()-1);
    else if(range==="year") start.setFullYear(end.getFullYear()-1);
    else start.setFullYear(end.getFullYear()-5);
    return [start.toLocaleDateString("sv-SE"), end.toLocaleDateString("sv-SE")];
  }
  function stringColor(str, idx=0){
    let h=0; for(let i=0;i<str.length;i++){ h = (h*31 + str.charCodeAt(i)) % 360; }
    const hue = (h + idx*137.508) % 360;
    return `hsl(${hue}deg 70% 55%)`;
  }
  function renderChart(){
    const state=loadState();
    const selectedIds = getSelectedFieldIds();
    const range=el("chartRange").value, agg=el("chartAgg").value, groupSel=el("chartGroup").value;
    const [from,to]=computeDateRange(range);
    const entries = Object.entries(state.entries).filter(([d])=>d>=from && d<=to).sort(([a],[b])=>a.localeCompare(b));
    const grpMode = groupSel==="auto" ? inferGroup(range) : groupSel;

    if(selectedIds.length===0){
      const first = eligibleFields()[0];
      if(!first){ drawEmpty(); return; }
      selectedIds.push(first.id);
      const n = el("chartFields").querySelector(`input[data-fid="${first.id}"]`); if(n) n.checked = true;
    }

    // Samle grupperte data for alle serier
    const labelsSet = new Set();
    const seriesStats = []; // {fid, name, groups:Map, max}
    selectedIds.forEach((fid)=>{
      const f = state.fields.find(x=>x.id===fid); if(!f) return;
      const rows = entries.map(([d,obj])=>{
        const raw = obj?.[fid];
        let val, has;
        if(f.type==="checkbox"){ val = raw===true ? 1 : 0; has = true; }
        else { if(raw===undefined || raw===null || raw===""){ val=0; has=false; } else { val=toNumber(raw); has=true; } }
        return [d,val,has];
      });

      const groups = new Map();
      for(const [d,v,has] of rows){
        const key = groupKey(d, grpMode);
        labelsSet.add(key);
        if(!groups.has(key)) groups.set(key, {sum:0, count:0});
        const g = groups.get(key);
        if(has){ g.sum += v; g.count += 1; }
      }
      const labelsSorted = Array.from(labelsSet).sort((a,b)=>a.localeCompare(b));
      let max = 0;
      labelsSorted.forEach(k=>{
        const g = groups.get(k) || {sum:0,count:0};
        const val = (agg==="sum") ? g.sum : (g.count? g.sum/g.count : 0);
        if(val>max) max=val;
      });
      seriesStats.push({ fid, name:f.name, groups, max });
    });

    const labels = Array.from(labelsSet).sort((a,b)=>a.localeCompare(b));
    const globalMax = seriesStats.reduce((m,s)=>Math.max(m,s.max),0);
    const smallMax = seriesStats.reduce((m,s)=> s.max>0 && s.max<m ? s.max : m, Number.POSITIVE_INFINITY);
    const hasBig = globalMax >= 20; // heuristic
    const hasSmall = smallMax <= 3;  // heuristic

    const datasets = seriesStats.map((s, idx)=>{
      const color = stringColor(s.fid, idx);
      const data = labels.map(k=>{
        const g = s.groups.get(k) || {sum:0,count:0};
        return (agg==="sum") ? g.sum : (g.count? g.sum/g.count : 0);
      });
      // Auto-akse: små på y1 hvis det også finnes store
      const useY1 = hasBig && s.max <= 3;
      return {
        label: s.name + (useY1 ? " (høyre akse)" : ""),
        data, tension:.3, fill:false, borderWidth:2, pointRadius:2,
        borderColor: color, pointBackgroundColor: color,
        yAxisID: useY1 ? "y1" : "y"
      };
    });

    const ctx=el("chart").getContext("2d");
    if(chart) chart.destroy();
    chart=new Chart(ctx,{
      type:"line",
      data:{ labels, datasets },
      options:{
        responsive:true,
        scales:{
          x:{ grid:{ color:"rgba(127,127,127,.15)"}, ticks:{ color:getTextColor() } },
          y:{ beginAtZero:true, grid:{ color:"rgba(127,127,127,.15)"}, ticks:{ color:getTextColor() } },
          y1:{ beginAtZero:true, position:"right", grid:{ drawOnChartArea:false }, ticks:{ color:getTextColor() } }
        },
        plugins:{ legend:{ labels:{ color:getTextColor() } }, tooltip:{ mode:"index", intersect:false } }
      }
    });
  }
  function drawEmpty(){ const ctx=el("chart").getContext("2d"); if(chart) chart.destroy(); chart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[{label:"",data:[]}]},options:{}}); }
  const getTextColor=()=>getComputedStyle(document.documentElement).getPropertyValue("--text").trim() || "#fff";

  /* ---------------- Kalender ---------------- */
  function addDays(iso,delta){ const d=new Date(iso+"T00:00:00"); d.setDate(d.getDate()+delta); return d.toLocaleDateString("sv-SE"); }
  function monthData(baseIso){
    const base=new Date(baseIso+"T00:00:00"); const year=base.getFullYear(), month=base.getMonth();
    const first=new Date(year,month,1); const startOffset=(first.getDay()+6)%7; const start=new Date(year,month,1-startOffset);
    const cells=[]; for(let i=0;i<42;i++){ const d=new Date(start); d.setDate(start.getDate()+i); const iso=d.toLocaleDateString("sv-SE"); cells.push({ iso, inMonth:d.getMonth()===month, day:d.getDate() }); }
    return {year,month,title:`${MONTHS[month]} ${year}`,cells};
  }
  function computeDayTotalPercent(iso){
    const state=loadState(); const day=state.entries[iso]||{};
    const parts=[];
    state.fields.forEach(f=>{
      if(!f.inProgress) return;
      if(f.type==="checkbox"){ parts.push(day[f.id]===true?1:0); }
      else if(f.type==="number" && Number(f.goal||0)>0){ const v=toNumber(day[f.id]); parts.push(Math.min(v/Number(f.goal),1)); }
    });
    if(!parts.length) return 0; return Math.round((parts.reduce((a,b)=>a+b,0)/parts.length)*100);
  }
  function renderCalendar(currentIso){
    const pop=el("calPop"); pop.innerHTML=""; let baseIso=currentIso||todayISO();
    const head=document.createElement("div"); head.className="cal-head";
    const title=document.createElement("div"); title.style.fontWeight="700";
    const prev=document.createElement("button"); prev.className="pill"; prev.textContent="←";
    const next=document.createElement("button"); next.className="pill"; next.textContent="→";
    const today=document.createElement("button"); today.className="pill"; today.textContent="I dag";
    head.appendChild(prev); head.appendChild(title); head.appendChild(next); head.appendChild(today);

    const dows=document.createElement("div"); dows.className="cal-grid"; ["Ma","Ti","On","To","Fr","Lø","Sø"].forEach(x=>{ const c=document.createElement("div"); c.className="cal-dow"; c.textContent=x; dows.appendChild(c); });
    const grid=document.createElement("div"); grid.className="cal-grid";

    function paint(){
      const md=monthData(baseIso); title.textContent=md.title; grid.innerHTML="";
      md.cells.forEach(c=>{
        const cell=document.createElement("div");
        const pct=computeDayTotalPercent(c.iso);
        let cls="cal-cell"; if(c.iso===el("datePicker").value) cls+=" sel";
        if(pct>=100) cls+=" good"; else if(pct>0) cls+=" bad";
        if(!c.inMonth) cls+=" muted";
        cell.className=cls; cell.textContent=c.day; cell.title=pct?`${pct}%`:"—";
        cell.onclick=()=>{ el("datePicker").value=c.iso; updateDateUI(); closeCal(); };
        grid.appendChild(cell);
      });
    }
    prev.onclick=()=>{ const d=new Date(baseIso+"T00:00:00"); d.setMonth(d.getMonth()-1); baseIso=d.toLocaleDateString("sv-SE"); paint(); };
    next.onclick=()=>{ const d=new Date(baseIso+"T00:00:00"); d.setMonth(d.getMonth()+1); baseIso=d.toLocaleDateString("sv-SE"); paint(); };
    today.onclick=()=>{ baseIso=todayISO(); el("datePicker").value=baseIso; updateDateUI(); closeCal(); };
    pop.appendChild(head); pop.appendChild(dows); pop.appendChild(grid); paint();
  }
  const openCal=()=>{ const pop=el("calPop"); pop.style.display="block"; renderCalendar(el("datePicker").value||todayISO()); };
  const closeCal=()=>{ el("calPop").style.display="none"; };

  /* ---------------- Tema UI ---------------- */
  function readSettings(){ return loadState().settings || defaultSettings(); }
  function writeSettings(mut){
    const s=loadState(); s.settings={...s.settings, ...mut}; saveState(s); applyTheme(s.settings); renderChart(); // oppdater graf-farger
    // Oppdater inputs
    initThemeInputs();
  }
  function initThemeInputs(){
    const s = readSettings();
    el("bgColor").value = s.bg;
    el("accentColor").value = s.accent;
    // Preview bruker CSS-variablene
  }
  document.querySelectorAll(".preset").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const p = btn.getAttribute("data-preset");
      const map = {
        dark:{theme:"dark", bg:"#0b0c10", accent:"#4f8cff"},
        light:{theme:"light", bg:"#f7f7f9", accent:"#4f8cff"},
        emerald:{theme:"emerald", bg:"#06110f", accent:"#10b981"},
        solar:{theme:"solar", bg:"#0d0f10", accent:"#f59e0b"}
      };
      writeSettings(map[p] || defaultSettings());
      showToast(`Tema satt: ${p}`);
    });
  });
  el("bgColor").addEventListener("change",(e)=> writeSettings({ bg:e.target.value }));
  el("accentColor").addEventListener("change",(e)=> writeSettings({ accent:e.target.value }));
  el("themeReset").onclick=()=>{ writeSettings(defaultSettings()); showToast("Tema nullstilt"); };

  /* ---------------- Handlers ---------------- */
  el("addField").onclick=()=>{
    const name=el("fName").value.trim(), type=el("fType").value, goalRaw=el("fGoal").value.trim(), inProg=el("fInProg").checked;
    if(!name) return;
    const s=loadState();
    s.fields.push({ id:uid(), name, type, inProgress:!!inProg, goal:(type==="number" && goalRaw)? Number(goalRaw):null });
    saveState(s);
    el("fName").value=""; el("fGoal").value=""; el("fInProg").checked=true;
    renderAll(); showToast("Felt lagt til ✅");
  };
  el("addPreset").onclick=()=>{
    const s=loadState(); const names=s.fields.map(f=>f.name);
    const add=(name,type,goal=null,inProg=true)=>{ if(!names.includes(name)) s.fields.push({id:uid(), name, type, goal, inProgress:inProg}); };
    add("Søvn (timer)","number",8,true);
    add("Søvnscore","number",100,true);
    add("Trening","checkbox",null,true);
    add("Lest","checkbox",null,true);
    add("Skole","checkbox",null,true);
    saveState(s); renderAll(); showToast("Forhåndsoppsett lagt til ✅");
  };
  el("resetAll").onclick=()=>{ if(!confirm("Slette alle felter og all data?")) return; localStorage.removeItem(LS_KEY); renderAll(); showToast("Alt slettet"); };
  el("save").onclick=()=>{
    const s=loadState(); const date=el("datePicker").value||todayISO(); const obj=s.entries[date]? {...s.entries[date]} : {};
    document.querySelectorAll("[data-id]").forEach(node=>{ const id=node.getAttribute("data-id"); obj[id] = node.type==="checkbox" ? node.checked : node.value; });
    s.entries[date]=obj; saveState(s);
    renderHistory(); renderKpi(); renderChart(); renderHearts(date);
    showToast("Lagret ✅");
  };
  el("export").onclick=()=>{ const s=loadState(); const blob=new Blob([JSON.stringify(s,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="livstracker-export-v3.json"; a.click(); URL.revokeObjectURL(a.href); };
  el("importFile").addEventListener("change", async (e)=>{
    const file=e.target.files?.[0]; if(!file) return; const text=await file.text();
    try{ const parsed=JSON.parse(text); if(!parsed.fields||!parsed.entries) throw new Error("Feil format");
      parsed.settings ||= defaultSettings(); saveState(parsed); renderAll(); showToast("Importert ✅");
    }catch{ showToast("Import feilet"); } finally{ e.target.value=""; }
  });

  function updateDateUI(){
    const iso=el("datePicker").value||todayISO();
    el("datePretty").textContent=prettyDate(iso);
    renderForm(iso); renderHearts(iso);
  }
  el("todayBtn").onclick=()=>{ el("datePicker").value=todayISO(); updateDateUI(); };
  el("prevDay").onclick=()=>{ const v=el("datePicker").value||todayISO(); el("datePicker").value=addDays(v,-1); updateDateUI(); };
  el("nextDay").onclick=()=>{ const v=el("datePicker").value||todayISO(); el("datePicker").value=addDays(v,+1); updateDateUI(); };
  el("datePicker").addEventListener("change", updateDateUI);
  el("openCal").onclick=(e)=>{ e.stopPropagation(); openCal(); };
  document.addEventListener("click",(e)=>{ if(!el("calPop").contains(e.target) && e.target!==el("openCal")) closeCal(); });

  ["chartRange","chartAgg","chartGroup"].forEach(id=> el(id).addEventListener("change", renderChart));

  /* ---------------- Init ---------------- */
  function renderAll(){
    const s=loadState(); applyTheme(s.settings); initThemeInputs();
    const dp=el("datePicker"); if(!dp.value) dp.value=todayISO(); el("datePretty").textContent=prettyDate(dp.value);
    renderFields(); renderForm(dp.value); renderHearts(dp.value); renderHistory(); renderKpi();
    renderChartControls(); renderChart();
  }
  renderAll();
</script>
</body>
</html>
